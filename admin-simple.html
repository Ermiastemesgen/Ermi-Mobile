<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Ermi Mobile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        h1 { color: #333; margin-bottom: 30px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-card h2 { font-size: 2.5rem; margin-bottom: 10px; }
        .stat-card.blue h2 { color: #3b82f6; }
        .stat-card.green h2 { color: #10b981; }
        .stat-card.orange h2 { color: #f59e0b; }
        .stat-card.purple h2 { color: #8b5cf6; }
        .stat-card p { color: #666; font-size: 1rem; }
        .section { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .section h2 { margin-bottom: 20px; color: #333; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f0f0f0; padding: 15px; text-align: left; font-weight: 600; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
        .badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .badge.admin { background: #fee2e2; color: #dc2626; }
        .badge.editor { background: #fef3c7; color: #f59e0b; }
        .badge.user { background: #d1fae5; color: #059669; }
        .badge:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        .nav { background: #1f2937; color: white; padding: 20px; margin-bottom: 30px; border-radius: 10px; }
        .nav a { color: white; text-decoration: none; margin-right: 20px; padding: 10px 15px; display: inline-block; }
        .nav a:hover { background: #374151; border-radius: 5px; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; margin: 0 5px; }
        .btn-edit { background: #3b82f6; color: white; }
        .btn-edit:hover { background: #2563eb; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-delete:hover { background: #dc2626; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; margin: auto; }
        .modal-content h2 { margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn-save { background: #10b981; color: white; flex: 1; padding: 12px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-save:hover { background: #059669; }
        .btn-cancel { background: #6b7280; color: white; flex: 1; padding: 12px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-cancel:hover { background: #4b5563; }
        .category-row { cursor: pointer; transition: background 0.2s; }
        .category-row:hover { background: #f9fafb; }
        .category-toggle { display: inline-block; width: 20px; text-align: center; font-weight: bold; user-select: none; }
        .category-children { display: none; }
        .category-children.expanded { display: table-row-group; }
        .category-name { display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal active">
        <div class="modal-content" style="max-width: 400px;">
            <h2 style="text-align: center; color: #2563eb; margin-bottom: 10px;">
                <i class="fas fa-lock"></i> Admin Login
            </h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Enter your credentials to access the admin panel
            </p>
            <form id="adminLoginForm" autocomplete="on">
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> Email</label>
                    <input 
                        type="email" 
                        id="adminEmail" 
                        name="email"
                        placeholder="admin@ermimobile.com" 
                        autocomplete="email"
                        required 
                        autofocus>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-key"></i> Password</label>
                    <input 
                        type="password" 
                        id="adminPassword" 
                        name="password"
                        placeholder="Enter password" 
                        autocomplete="current-password"
                        required>
                </div>
                <div id="loginError" style="color: #ef4444; margin-bottom: 15px; display: none; text-align: center;"></div>
                <button type="submit" class="btn-save" style="width: 100%; padding: 15px; font-size: 1rem;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <p style="text-align: center; margin-top: 15px; color: #666; font-size: 0.85rem;">
                    üí° Default: admin@ermimobile.com / admin123
                </p>
            </form>
            <p style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9rem;">
                <a href="index.html" style="color: #2563eb; text-decoration: none;">
                    <i class="fas fa-arrow-left"></i> Back to Store
                </a>
            </p>
        </div>
    </div>

    <div class="container" id="adminContent" style="display: none;">
        <div class="nav">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <a href="#" onclick="showSection('dashboard')">üìä Dashboard</a>
                    <a href="#" onclick="showSection('users')">üë• Users</a>
                    <a href="#" onclick="showSection('categories')">üìÅ Categories</a>
                    <a href="#" onclick="showSection('products')">üì¶ Products</a>
                    <a href="#" onclick="showSection('orders')">üõí Orders</a>
                    <a href="#" onclick="showSection('settings')">‚öôÔ∏è Settings</a>
                    <a href="index.html">üè† Back to Store</a>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="currentUserInfo" style="color: #d1d5db;"></span>
                    <button onclick="logout()" class="btn-delete" style="padding: 8px 15px;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <h1>Ermi Mobile Admin Dashboard</h1>

        <div id="dashboard-section">
            <div class="stats">
                <div class="stat-card blue">
                    <h2 id="totalUsers">...</h2>
                    <p><i class="fas fa-users"></i> Total Users</p>
                </div>
                <div class="stat-card green">
                    <h2 id="totalProducts">...</h2>
                    <p><i class="fas fa-box"></i> Total Products</p>
                </div>
                <div class="stat-card orange">
                    <h2 id="totalOrders">...</h2>
                    <p><i class="fas fa-shopping-cart"></i> Total Orders</p>
                </div>
                <div class="stat-card purple">
                    <h2 id="totalRevenue">...</h2>
                    <p><i class="fas fa-money-bill-wave"></i> Total Revenue (Approved)</p>
                </div>
            </div>
        </div>

        <div id="users-section" class="section">
            <h2>üë• Users</h2>
            <table>
                <thead>
                    <tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Created</th></tr>
                </thead>
                <tbody id="usersTable"><tr><td colspan="5">Loading...</td></tr></tbody>
            </table>
        </div>

        <div id="categories-section" class="section">
            <h2>üìÅ Categories (Hierarchical)</h2>
            <button class="btn btn-edit" onclick="openAddCategoryModal()" style="margin-bottom: 20px;">
                <i class="fas fa-plus"></i> Add Category
            </button>
            <table>
                <thead>
                    <tr><th>ID</th><th>Category Hierarchy</th><th>Description</th><th>Actions</th></tr>
                </thead>
                <tbody id="categoriesTable"><tr><td colspan="4">Loading...</td></tr></tbody>
            </table>
        </div>

        <div id="products-section" class="section">
            <h2>üì¶ Products</h2>
            <button class="btn btn-edit" onclick="openAddProductModal()" style="margin-bottom: 20px;">
                <i class="fas fa-plus"></i> Add Product
            </button>
            <table>
                <thead>
                    <tr><th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Icon</th><th>Stock</th><th>Actions</th></tr>
                </thead>
                <tbody id="productsTable"><tr><td colspan="7">Loading...</td></tr></tbody>
            </table>
        </div>

        <div id="orders-section" class="section">
            <h2>üõí Orders</h2>
            <table>
                <thead>
                    <tr><th>Order ID</th><th>User ID</th><th>Total</th><th>Payment</th><th>Receipt</th><th>Delivery Address</th><th>Phone</th><th>Status</th><th>Date</th><th>Actions</th></tr>
                </thead>
                <tbody id="ordersTable"><tr><td colspan="10">Loading...</td></tr></tbody>
            </table>
        </div>

        <div id="contacts-section" class="section">
            <h2>üìß Contact Messages</h2>
            <table>
                <thead>
                    <tr><th>ID</th><th>Name</th><th>Email</th><th>Message</th><th>Status</th><th>Date</th><th>Actions</th></tr>
                </thead>
                <tbody id="contactsTable"><tr><td colspan="7">Loading...</td></tr></tbody>
            </table>
        </div>

        <div id="settings-section" class="section">
            <h2>‚öôÔ∏è Website Settings</h2>
            <div style="max-width: 800px;">
                <h3 style="margin-bottom: 20px;">Hero Section (Main Page Header)</h3>
                <form id="settingsForm">
                    <div class="form-group">
                        <label>Site Name</label>
                        <input type="text" id="setting_site_name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div class="form-group">
                        <label>Hero Title</label>
                        <input type="text" id="setting_hero_title" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div class="form-group">
                        <label>Hero Subtitle</label>
                        <input type="text" id="setting_hero_subtitle" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div class="form-group">
                        <label>Button Text</label>
                        <input type="text" id="setting_hero_button_text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div class="form-group">
                        <label>Hero Background Image</label>
                        <input type="file" id="setting_hero_image" accept="image/*" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #666;">Upload a background image for the hero section (JPG, PNG, GIF - Max 50MB for 4K quality)</small>
                        <div id="heroImagePreview" style="margin-top: 10px;"></div>
                    </div>
                    
                    <h3 style="margin-top: 40px; margin-bottom: 20px;">About Section</h3>
                    
                    <div class="form-group">
                        <label>About Text</label>
                        <textarea id="setting_about_text" rows="6" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; font-family: inherit; resize: vertical;"></textarea>
                        <small style="color: #666;">Text displayed in the About section of your website</small>
                    </div>
                    
                    <h3 style="margin-top: 40px; margin-bottom: 20px;">Color Settings</h3>
                    
                    <div class="form-group">
                        <label>Primary Color (Buttons, Links)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="color" id="setting_primary_color" style="width: 80px; height: 50px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                            <input type="text" id="setting_primary_color_text" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="#2563eb">
                        </div>
                        <small style="color: #666;">Color used for buttons, links, and accents</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Text Color (Body Text)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="color" id="setting_text_color" style="width: 80px; height: 50px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                            <input type="text" id="setting_text_color_text" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="#1f2937">
                        </div>
                        <small style="color: #666;">Color used for paragraphs and body text</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Heading Color (Titles)</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="color" id="setting_heading_color" style="width: 80px; height: 50px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                            <input type="text" id="setting_heading_color_text" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="#1f2937">
                        </div>
                        <small style="color: #666;">Color used for headings and titles</small>
                    </div>
                    
                    <h3 style="margin-top: 40px; margin-bottom: 20px;">Social Media Links</h3>
                    
                    <div class="form-group">
                        <label><i class="fab fa-facebook" style="color: #1877f2;"></i> Facebook URL</label>
                        <input type="url" id="setting_social_facebook" placeholder="https://facebook.com/yourpage" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #666;">Your Facebook page or profile URL</small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fab fa-instagram" style="color: #e4405f;"></i> Instagram URL</label>
                        <input type="url" id="setting_social_instagram" placeholder="https://instagram.com/yourhandle" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #666;">Your Instagram profile URL</small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fab fa-tiktok" style="color: #000000;"></i> TikTok URL</label>
                        <input type="url" id="setting_social_tiktok" placeholder="https://tiktok.com/@yourhandle" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #666;">Your TikTok profile URL</small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fab fa-telegram" style="color: #0088cc;"></i> Telegram URL</label>
                        <input type="url" id="setting_social_telegram" placeholder="https://t.me/yourchannel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #666;">Your Telegram channel or group URL</small>
                    </div>
                    
                    <h3 style="margin-top: 40px; margin-bottom: 20px;">Contact Information</h3>
                    
                    <div class="form-group">
                        <label><i class="fas fa-phone" style="color: #10b981;"></i> Phone Number</label>
                        <input type="tel" id="setting_phone_number" placeholder="+251912345678" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #666;">Phone number with country code (e.g., +251912345678)</small>
                    </div>
                    
                    <h3 style="margin-top: 40px; margin-bottom: 20px;">Payment Information</h3>
                    <p style="color: #666; margin-bottom: 20px;">Configure payment account details shown to customers during checkout</p>
                    
                    <div class="form-group">
                        <label><i class="fas fa-mobile-alt" style="color: #f59e0b;"></i> Telebirr Account Name</label>
                        <input type="text" id="setting_telebirr_name" placeholder="Ermi Mobile Shop" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-mobile-alt" style="color: #f59e0b;"></i> Telebirr Phone Number</label>
                        <input type="tel" id="setting_telebirr_phone" placeholder="+251 911 234 567" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #666;">Phone number for Telebirr payments</small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-mobile-alt" style="color: #f59e0b;"></i> Telebirr Payment Instructions</label>
                        <textarea id="setting_telebirr_instructions" rows="2" placeholder="Please transfer the total amount and keep your transaction reference number." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; resize: vertical;"></textarea>
                        <small style="color: #666;">Instructions shown to customers for Telebirr payments</small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-university" style="color: #3b82f6;"></i> CBE Birr Account Name</label>
                        <input type="text" id="setting_cbe_name" placeholder="Ermi Mobile Trading" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-university" style="color: #3b82f6;"></i> CBE Birr Account Number</label>
                        <input type="text" id="setting_cbe_account" placeholder="1000123456789" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #666;">CBE Birr account number</small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-university" style="color: #3b82f6;"></i> CBE Birr Payment Instructions</label>
                        <textarea id="setting_cbe_instructions" rows="2" placeholder="Transfer the amount via CBE Birr and save your receipt." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; resize: vertical;"></textarea>
                        <small style="color: #666;">Instructions shown to customers for CBE Birr payments</small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-credit-card" style="color: #8b5cf6;"></i> Bank Name</label>
                        <input type="text" id="setting_bank_name" placeholder="Commercial Bank of Ethiopia" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-credit-card" style="color: #8b5cf6;"></i> Bank Account Name</label>
                        <input type="text" id="setting_bank_account_name" placeholder="Ermi Mobile Trading PLC" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-credit-card" style="color: #8b5cf6;"></i> Bank Account Number</label>
                        <input type="text" id="setting_bank_account_number" placeholder="1000987654321" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <small style="color: #666;">Bank account number for transfers</small>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-credit-card" style="color: #8b5cf6;"></i> Bank Transfer Payment Instructions</label>
                        <textarea id="setting_bank_instructions" rows="2" placeholder="Please transfer the total amount and keep your transaction slip." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; resize: vertical;"></textarea>
                        <small style="color: #666;">Instructions shown to customers for bank transfers</small>
                    </div>
                    
                    <h3 style="margin-top: 40px; margin-bottom: 20px;">Typography Settings</h3>
                    
                    <div class="form-group">
                        <label>Body Font Family</label>
                        <select id="setting_font_family" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                            <option value="Segoe UI, Tahoma, Geneva, Verdana, sans-serif">Segoe UI (Default)</option>
                            <option value="Arial, Helvetica, sans-serif">Arial</option>
                            <option value="'Times New Roman', Times, serif">Times New Roman</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Courier New', Courier, monospace">Courier New</option>
                            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                            <option value="Impact, Charcoal, sans-serif">Impact</option>
                            <option value="'Lucida Sans', sans-serif">Lucida Sans</option>
                            <option value="Roboto, sans-serif">Roboto (Google Font)</option>
                            <option value="'Open Sans', sans-serif">Open Sans (Google Font)</option>
                            <option value="Lato, sans-serif">Lato (Google Font)</option>
                            <option value="Montserrat, sans-serif">Montserrat (Google Font)</option>
                            <option value="Poppins, sans-serif">Poppins (Google Font)</option>
                        </select>
                        <small style="color: #666;">Font used for body text and paragraphs</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Heading Font Family</label>
                        <select id="setting_heading_font" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                            <option value="Segoe UI, Tahoma, Geneva, Verdana, sans-serif">Segoe UI (Default)</option>
                            <option value="Arial, Helvetica, sans-serif">Arial</option>
                            <option value="'Times New Roman', Times, serif">Times New Roman</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Courier New', Courier, monospace">Courier New</option>
                            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                            <option value="Impact, Charcoal, sans-serif">Impact</option>
                            <option value="'Lucida Sans', sans-serif">Lucida Sans</option>
                            <option value="Roboto, sans-serif">Roboto (Google Font)</option>
                            <option value="'Open Sans', sans-serif">Open Sans (Google Font)</option>
                            <option value="Lato, sans-serif">Lato (Google Font)</option>
                            <option value="Montserrat, sans-serif">Montserrat (Google Font)</option>
                            <option value="Poppins, sans-serif">Poppins (Google Font)</option>
                        </select>
                        <small style="color: #666;">Font used for headings and titles</small>
                    </div>
                    
                    <button type="submit" class="btn btn-edit" style="padding: 12px 30px; font-size: 1rem;">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </form>
                <div id="settingsMessage" style="margin-top: 20px; padding: 15px; border-radius: 5px; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <h2>Add New Category</h2>
            <form id="addCategoryForm">
                <div class="form-group">
                    <label>Parent Category (Optional)</label>
                    <select id="newCategoryParent" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                        <option value="">None (Top Level)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category Name</label>
                    <input type="text" id="newCategoryName" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="newCategoryDesc" required>
                </div>
                <div class="form-group">
                    <label>Category Image (Optional)</label>
                    <input type="file" id="newCategoryImage" accept="image/*" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666;">Upload an image for this category (JPG, PNG, GIF)</small>
                    <div id="newCategoryImagePreview" style="margin-top: 10px;"></div>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-save">Create Category</button>
                    <button type="button" class="btn-cancel" onclick="closeAddCategoryModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quick Change Category Modal -->
    <div id="quickCategoryModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h2>Change Category</h2>
            <p id="quickCategoryProductName" style="color: #666; margin-bottom: 20px;"></p>
            <form id="quickCategoryForm">
                <input type="hidden" id="quickCategoryProductId">
                <div class="form-group">
                    <label>Select Category</label>
                    <select id="quickCategorySelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                        <option value="">No Category</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-save">Change Category</button>
                    <button type="button" class="btn-cancel" onclick="closeQuickCategoryModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="editCategoryModal" class="modal">
        <div class="modal-content">
            <h2>Edit Category</h2>
            <form id="editCategoryForm">
                <input type="hidden" id="editCategoryId">
                <div class="form-group">
                    <label>Parent Category (Optional)</label>
                    <select id="editCategoryParent" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                        <option value="">None (Top Level)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category Name</label>
                    <input type="text" id="editCategoryName" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="editCategoryDesc" required>
                </div>
                <div class="form-group">
                    <label>Category Image (Optional)</label>
                    <input type="file" id="editCategoryImage" accept="image/*" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <small style="color: #666;">Upload a new image to replace the current one</small>
                    <div id="editCategoryImagePreview" style="margin-top: 10px;"></div>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-save">Save Changes</button>
                    <button type="button" class="btn-cancel" onclick="closeEditCategoryModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <h2>Add New Product</h2>
            <form id="addProductForm">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="newProductName" required>
                </div>
                <div class="form-group">
                    <label>Price ($)</label>
                    <input type="number" id="newProductPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="newProductCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                        <option value="">No Category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Icon (Font Awesome class)</label>
                    <input type="text" id="newProductIcon" placeholder="fa-headphones" required>
                </div>
                <div class="form-group">
                    <label>Stock</label>
                    <input type="number" id="newProductStock" value="100" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="newProductDesc" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; resize: vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label>Product Images (Multiple)</label>
                    <input type="file" id="newProductImage" accept="image/*" multiple>
                    <small style="color: #666;">Upload multiple product images (JPG, PNG, GIF, WebP - Max 50MB each, up to 10 images)</small>
                    <div id="newProductImagePreview" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-save">Create Product</button>
                    <button type="button" class="btn-cancel" onclick="closeAddProductModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>Edit Product</h2>
            <form id="editForm">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label>Price ($)</label>
                    <input type="number" id="editPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="editCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;">
                        <option value="">No Category</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Icon (Font Awesome class)</label>
                    <input type="text" id="editIcon" placeholder="fa-headphones" required>
                </div>
                <div class="form-group">
                    <label>Stock</label>
                    <input type="number" id="editStock" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="editDescription" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; resize: vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label>Product Images (Multiple)</label>
                    <input type="file" id="editImage" accept="image/*" multiple>
                    <small style="color: #666;">Upload multiple product images (JPG, PNG, GIF, WebP - Max 50MB each, up to 10 images)</small>
                    <div id="imagePreview" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-save">Save Changes</button>
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Automatically detect if running locally or on production
        const API = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api' 
            : `${window.location.origin}/api`;
        let currentProducts = [];
        let categories = [];
        let currentUser = null;

        // Check if user is already logged in
        function checkAuth() {
            const savedUser = localStorage.getItem('adminUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showAdminPanel();
            }
        }

        // Show admin panel
        function showAdminPanel() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('adminContent').style.display = 'block';
            
            // Display user info
            const roleColor = currentUser.role === 'admin' ? '#ef4444' : '#f59e0b';
            const roleIcon = currentUser.role === 'admin' ? 'üëë' : '‚úèÔ∏è';
            document.getElementById('currentUserInfo').innerHTML = `
                ${roleIcon} <strong>${currentUser.name}</strong> 
                <span style="color: ${roleColor};">(${currentUser.role})</span>
            `;
            
            // Load data
            loadStats();
            loadProducts();
            loadCategories();
            loadOrders();
        }

        // Login form handler
        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch(API + '/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Check if user has admin or editor role
                    if (data.user.role !== 'admin' && data.user.role !== 'editor') {
                        errorDiv.textContent = '‚ùå Access denied. Admin or editor privileges required.';
                        errorDiv.style.display = 'block';
                        return;
                    }
                    
                    // Save user info
                    currentUser = data.user;
                    localStorage.setItem('adminUser', JSON.stringify(currentUser));
                    
                    // Show admin panel
                    showAdminPanel();
                } else {
                    errorDiv.textContent = '‚ùå ' + (data.error || 'Login failed');
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = '‚ùå Server error. Please try again.';
                errorDiv.style.display = 'block';
            }
        });

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('adminUser');
                currentUser = null;
                document.getElementById('adminContent').style.display = 'none';
                document.getElementById('loginModal').classList.add('active');
                document.getElementById('adminLoginForm').reset();
                document.getElementById('loginError').style.display = 'none';
                // Ensure email field is enabled
                document.getElementById('adminEmail').disabled = false;
                document.getElementById('adminPassword').disabled = false;
            }
        }

        // Check auth on page load
        checkAuth();

        function toggleCategory(catId) {
            const childRows = document.querySelectorAll(`[data-parent="${catId}"]`);
            const toggle = document.getElementById(`toggle-${catId}`);
            const isExpanded = toggle.textContent === '‚ñº';
            
            childRows.forEach(row => {
                if (isExpanded) {
                    row.style.display = 'none';
                    // Also collapse nested children
                    const rowCatId = row.dataset.category;
                    const nestedToggle = document.getElementById(`toggle-${rowCatId}`);
                    if (nestedToggle) {
                        nestedToggle.textContent = '‚ñ∂';
                    }
                } else {
                    row.style.display = 'table-row';
                }
            });
            
            toggle.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
        }

        async function loadCategories() {
            try {
                const response = await fetch(API + '/categories');
                const data = await response.json();
                categories = data.categories;
                
                // Check which categories have children
                const hasChildren = (catId) => {
                    return categories.some(c => c.parent_id === catId);
                };
                
                // Build hierarchy display with collapsible rows
                const buildHierarchy = (parentId = null, level = 0) => {
                    return categories
                        .filter(cat => cat.parent_id === parentId)
                        .map(cat => {
                            const indent = '&nbsp;&nbsp;&nbsp;&nbsp;'.repeat(level);
                            const hasChild = hasChildren(cat.id);
                            const toggle = hasChild ? `<span id="toggle-${cat.id}" class="category-toggle" onclick="toggleCategory(${cat.id})">‚ñ∂</span>` : '<span class="category-toggle"></span>';
                            
                            const row = `
                                <tr class="category-row" data-category="${cat.id}" data-parent="${cat.parent_id || 'root'}" ${level > 0 ? 'style="display: none;"' : ''}>
                                    <td>${cat.id}</td>
                                    <td>
                                        <div class="category-name">
                                            ${indent}${toggle}${cat.name}
                                        </div>
                                    </td>
                                    <td>${cat.description}</td>
                                    <td>
                                        <button class="btn btn-edit" onclick="editCategory(${cat.id})">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn btn-delete" onclick="deleteCategory(${cat.id}, '${cat.name}')">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </td>
                                </tr>
                            `;
                            const children = buildHierarchy(cat.id, level + 1);
                            return row + children;
                        }).join('');
                };
                
                // Update category selects with hierarchy
                const buildSelectOptions = (parentId = null, level = 0) => {
                    return categories
                        .filter(cat => cat.parent_id === parentId)
                        .map(cat => {
                            const indent = '&nbsp;&nbsp;'.repeat(level);
                            const prefix = level > 0 ? '‚îî‚îÄ ' : '';
                            const option = `<option value="${cat.id}">${indent}${prefix}${cat.name}</option>`;
                            const children = buildSelectOptions(cat.id, level + 1);
                            return option + children;
                        }).join('');
                };
                
                const selectHTML = '<option value="">No Category</option>' + buildSelectOptions();
                const selects = ['editCategory', 'newProductCategory', 'quickCategorySelect'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = selectHTML;
                    }
                });
                
                // Update parent category selects
                const parentSelectHTML = '<option value="">None (Top Level)</option>' + buildSelectOptions();
                const parentSelects = ['newCategoryParent', 'editCategoryParent'];
                parentSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = parentSelectHTML;
                    }
                });
                
                // Update categories table
                const tbody = document.getElementById('categoriesTable');
                if (tbody) {
                    tbody.innerHTML = buildHierarchy();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function openAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.add('active');
        }

        function closeAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.remove('active');
            document.getElementById('addCategoryForm').reset();
        }

        function openAddProductModal() {
            document.getElementById('addProductModal').classList.add('active');
        }

        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.remove('active');
            document.getElementById('addProductForm').reset();
        }

        // Preview category image before upload
        document.getElementById('newCategoryImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('newCategoryImagePreview').innerHTML = 
                        '<p style="color: #666; margin-bottom: 5px;">Preview:</p>' +
                        '<img src="' + e.target.result + '" style="max-width: 200px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const categoryData = {
                name: document.getElementById('newCategoryName').value,
                description: document.getElementById('newCategoryDesc').value,
                parent_id: document.getElementById('newCategoryParent').value || null
            };
            
            try {
                const response = await fetch(API + '/admin/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(categoryData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Upload image if selected
                    const imageFile = document.getElementById('newCategoryImage').files[0];
                    if (imageFile) {
                        const formData = new FormData();
                        formData.append('image', imageFile);
                        
                        await fetch(API + '/admin/categories/' + data.categoryId + '/upload', {
                            method: 'POST',
                            body: formData
                        });
                    }
                    
                    alert('‚úÖ Category created successfully!');
                    closeAddCategoryModal();
                    loadCategories();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error creating category: ' + error.message);
            }
        });

        // Preview new product images (multiple)
        document.getElementById('newProductImage').addEventListener('change', function(e) {
            const files = e.target.files;
            const preview = document.getElementById('newProductImagePreview');
            preview.innerHTML = '';
            
            if (files.length > 0) {
                preview.innerHTML = '<p style="color: #666; margin-bottom: 10px; width: 100%;">Preview (' + files.length + ' images):</p>';
                
                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.cssText = 'position: relative;';
                        imgDiv.innerHTML = '<img src="' + e.target.result + '" style="width: 150px; height: 150px; object-fit: cover; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"><div style="position: absolute; top: 5px; right: 5px; background: #2563eb; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">' + (index + 1) + '</div>';
                        preview.appendChild(imgDiv);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        document.getElementById('addProductForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productData = {
                name: document.getElementById('newProductName').value,
                price: parseFloat(document.getElementById('newProductPrice').value),
                category_id: parseInt(document.getElementById('newProductCategory').value) || null,
                icon: document.getElementById('newProductIcon').value,
                stock: parseInt(document.getElementById('newProductStock').value),
                description: document.getElementById('newProductDesc').value
            };
            
            try {
                console.log('Creating product:', productData);
                const response = await fetch(API + '/admin/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();
                console.log('Product creation response:', data);
                
                if (response.ok) {
                    const imageFiles = document.getElementById('newProductImage').files;
                    if (imageFiles.length > 0) {
                        console.log('Uploading', imageFiles.length, 'images for product:', data.productId);
                        const formData = new FormData();
                        
                        // Add all images to FormData
                        Array.from(imageFiles).forEach(file => {
                            formData.append('images', file);
                        });
                        
                        const uploadResponse = await fetch(API + '/admin/products/' + data.productId + '/upload-multiple', {
                            method: 'POST',
                            body: formData
                        });
                        const uploadData = await uploadResponse.json();
                        console.log('Images upload response:', uploadData);
                        if (!uploadResponse.ok) {
                            alert('‚ö†Ô∏è Product created but images upload failed: ' + uploadData.error);
                        }
                    }
                    
                    alert('‚úÖ Product created successfully!');
                    closeAddProductModal();
                    // Small delay to ensure database is updated
                    setTimeout(() => {
                        loadProducts();
                        loadStats();
                    }, 300);
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error creating product:', error);
                alert('‚ùå Error creating product: ' + error.message);
            }
        });

        // Preview edit category image
        document.getElementById('editCategoryImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editCategoryImagePreview').innerHTML = 
                        '<p style="color: #666; margin-bottom: 5px;">New Preview:</p>' +
                        '<img src="' + e.target.result + '" style="max-width: 200px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
                };
                reader.readAsDataURL(file);
            }
        });

        function editCategory(id) {
            const category = categories.find(c => c.id === id);
            if (!category) return;
            
            document.getElementById('editCategoryId').value = category.id;
            document.getElementById('editCategoryName').value = category.name;
            document.getElementById('editCategoryDesc').value = category.description;
            document.getElementById('editCategoryParent').value = category.parent_id || '';
            
            // Show current image if exists
            if (category.image) {
                document.getElementById('editCategoryImagePreview').innerHTML = 
                    '<p style="color: #666; margin-bottom: 5px;">Current Image:</p>' +
                    '<img src="' + category.image + '" style="max-width: 200px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
            } else {
                document.getElementById('editCategoryImagePreview').innerHTML = '';
            }
            
            // Disable selecting itself as parent
            const parentSelect = document.getElementById('editCategoryParent');
            Array.from(parentSelect.options).forEach(option => {
                option.disabled = (option.value == id);
            });
            
            document.getElementById('editCategoryModal').classList.add('active');
        }

        function closeEditCategoryModal() {
            document.getElementById('editCategoryModal').classList.remove('active');
            document.getElementById('editCategoryForm').reset();
        }

        document.getElementById('editCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('editCategoryId').value;
            const categoryData = {
                name: document.getElementById('editCategoryName').value,
                description: document.getElementById('editCategoryDesc').value,
                parent_id: document.getElementById('editCategoryParent').value || null
            };
            
            try {
                const response = await fetch(API + '/admin/categories/' + id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(categoryData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Upload image if selected
                    const imageFile = document.getElementById('editCategoryImage').files[0];
                    if (imageFile) {
                        const formData = new FormData();
                        formData.append('image', imageFile);
                        
                        await fetch(API + '/admin/categories/' + id + '/upload', {
                            method: 'POST',
                            body: formData
                        });
                    }
                    
                    alert('‚úÖ Category updated successfully!');
                    closeEditCategoryModal();
                    loadCategories();
                    loadProducts();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error updating category: ' + error.message);
            }
        });

        function quickChangeCategory(productId, productName) {
            document.getElementById('quickCategoryProductId').value = productId;
            document.getElementById('quickCategoryProductName').textContent = 'Product: ' + productName;
            
            const product = currentProducts.find(p => p.id === productId);
            if (product) {
                document.getElementById('quickCategorySelect').value = product.category_id || '';
            }
            
            document.getElementById('quickCategoryModal').classList.add('active');
        }

        function closeQuickCategoryModal() {
            document.getElementById('quickCategoryModal').classList.remove('active');
        }

        document.getElementById('quickCategoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('quickCategoryProductId').value;
            const categoryId = document.getElementById('quickCategorySelect').value;
            
            const product = currentProducts.find(p => p.id == productId);
            if (!product) return;
            
            const productData = {
                name: product.name,
                price: product.price,
                icon: product.icon,
                stock: product.stock,
                image: product.image,
                category_id: categoryId ? parseInt(categoryId) : null
            };
            
            try {
                const response = await fetch(API + '/admin/products/' + productId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const categoryName = categories.find(c => c.id == categoryId)?.name || 'Uncategorized';
                    alert('‚úÖ Category changed to: ' + categoryName);
                    closeQuickCategoryModal();
                    loadProducts();
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error changing category: ' + error.message);
            }
        });

        async function deleteCategory(id, name) {
            if (confirm('Are you sure you want to delete category "' + name + '"? Products in this category will become uncategorized.')) {
                try {
                    const response = await fetch(API + '/admin/categories/' + id, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert('‚úÖ Category deleted successfully!');
                        loadCategories();
                        loadProducts();
                    } else {
                        alert('‚ùå Error: ' + data.error);
                    }
                } catch (error) {
                    alert('‚ùå Error deleting category: ' + error.message);
                }
            }
        }

        async function loadStats() {
            try {
                const [users, products, orders] = await Promise.all([
                    fetch(API + '/admin/users').then(r => r.json()),
                    fetch(API + '/products').then(r => r.json()),
                    fetch(API + '/admin/orders').then(r => r.json())
                ]);
                
                console.log('Stats loaded:', { users, products, orders });
                
                document.getElementById('totalUsers').textContent = users.users?.length || 0;
                document.getElementById('totalProducts').textContent = products.products?.length || 0;
                document.getElementById('totalOrders').textContent = orders.orders?.length || 0;
                
                // Calculate revenue only from approved orders
                const revenue = orders.orders?.reduce((sum, o) => {
                    if (o.status === 'approved') {
                        return sum + (o.total || 0);
                    }
                    return sum;
                }, 0) || 0;
                document.getElementById('totalRevenue').textContent = revenue.toFixed(2) + ' Birr';
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('totalUsers').textContent = '0';
                document.getElementById('totalProducts').textContent = '0';
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('totalRevenue').textContent = '0.00 Birr';
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch(API + '/admin/users');
                const data = await response.json();
                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = data.users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="badge ${user.role}">${user.role}</span></td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch(API + '/products');
                const data = await response.json();
                currentProducts = data.products;
                const tbody = document.getElementById('productsTable');
                tbody.innerHTML = data.products.map(product => `
                    <tr>
                        <td>${product.id}</td>
                        <td>
                            ${product.image ? '<img src="' + product.image + '" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; margin-right: 10px; vertical-align: middle;">' : ''}
                            ${product.name}
                        </td>
                        <td>
                            <span class="badge" 
                                  style="background: #e0e7ff; color: #4338ca; cursor: pointer; transition: all 0.3s;" 
                                  onclick="quickChangeCategory(${product.id}, '${product.name}')"
                                  title="Click to change category">
                                ${product.category_name || 'Uncategorized'} <i class="fas fa-edit" style="font-size: 0.8em;"></i>
                            </span>
                        </td>
                        <td>$${product.price.toFixed(2)}</td>
                        <td><i class="fas ${product.icon}"></i></td>
                        <td>${product.stock || 100}</td>
                        <td>
                            <button class="btn btn-edit" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-delete" onclick="deleteProduct(${product.id}, '${product.name}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        async function loadOrders() {
            try {
                const response = await fetch(API + '/admin/orders');
                const data = await response.json();
                console.log('Orders loaded:', data.orders);
                const tbody = document.getElementById('ordersTable');
                if (data.orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10">No orders yet</td></tr>';
                } else {
                    tbody.innerHTML = data.orders.map(order => {
                        console.log('Order:', order.id, 'Receipt:', order.payment_receipt);
                        const statusBadge = order.status === 'pending' 
                            ? '<span class="badge" style="background: #fef3c7; color: #92400e;">‚è≥ Pending</span>'
                            : order.status === 'approved' 
                            ? '<span class="badge" style="background: #d1fae5; color: #065f46;">‚úÖ Approved</span>'
                            : '<span class="badge" style="background: #fee2e2; color: #991b1b;">‚ùå Rejected</span>';
                        
                        const actionButtons = order.status === 'pending'
                            ? `<button class="btn btn-edit" onclick="updateOrderStatus(${order.id}, 'approved')" style="background: #10b981; margin-right: 5px; margin-bottom: 5px;">
                                   <i class="fas fa-check"></i> Approve
                               </button>
                               <button class="btn btn-delete" onclick="updateOrderStatus(${order.id}, 'rejected')" style="margin-right: 5px; margin-bottom: 5px;">
                                   <i class="fas fa-times"></i> Reject
                               </button>
                               <button class="btn btn-delete" onclick="deleteOrder(${order.id})" style="background: #dc2626; margin-bottom: 5px;">
                                   <i class="fas fa-trash"></i> Delete
                               </button>`
                            : `<button class="btn btn-delete" onclick="deleteOrder(${order.id})" style="background: #dc2626;">
                                   <i class="fas fa-trash"></i> Delete
                               </button>`;
                        
                        const paymentBadge = order.payment_method 
                            ? `<span class="badge" style="background: #e0e7ff; color: #4338ca;">${order.payment_method.toUpperCase()}</span>`
                            : 'N/A';
                        
                        const receiptDisplay = order.payment_receipt
                            ? `<a href="${order.payment_receipt}" target="_blank" style="color: #10b981; text-decoration: none;">
                                   <i class="fas fa-image"></i> View
                               </a>`
                            : '<span style="color: #9ca3af;">No receipt</span>';
                        
                        const deliveryAddress = order.delivery_address 
                            ? `<div style="max-width: 250px; font-size: 0.9rem; line-height: 1.4;">
                                   ${order.delivery_address.split(', ').map(part => '<div>' + part + '</div>').join('')}
                               </div>`
                            : '<span style="color: #9ca3af;">N/A</span>';
                        
                        const phoneNumber = order.phone_number || '<span style="color: #9ca3af;">N/A</span>';
                        
                        return `
                            <tr>
                                <td>#${order.id}</td>
                                <td>${order.user_id || 'Guest'}</td>
                                <td>${order.total.toFixed(2)} Birr</td>
                                <td>${paymentBadge}</td>
                                <td>${receiptDisplay}</td>
                                <td>${deliveryAddress}</td>
                                <td>${phoneNumber}</td>
                                <td>${statusBadge}</td>
                                <td>${new Date(order.created_at).toLocaleDateString()}</td>
                                <td>${actionButtons}</td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        async function updateOrderStatus(orderId, status) {
            const statusText = status === 'approved' ? 'approve' : 'reject';
            if (!confirm(`Are you sure you want to ${statusText} order #${orderId}?`)) {
                return;
            }

            try {
                console.log('Updating order status:', orderId, status);
                const url = API + '/admin/orders/' + orderId + '/status';
                console.log('Request URL:', url);
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    alert(`‚úÖ Order #${orderId} ${status} successfully!`);
                    loadOrders();
                    loadStats();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                    console.error('Server error:', data);
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('‚ùå Error updating order status: ' + error.message);
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm(`Are you sure you want to delete order #${orderId}? This action cannot be undone!`)) {
                return;
            }

            try {
                console.log('Deleting order:', orderId);
                const url = API + '/admin/orders/' + orderId;
                console.log('DELETE URL:', url);
                
                const response = await fetch(url, {
                    method: 'DELETE'
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers.get('content-type'));

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    alert('‚ùå Server error: Expected JSON response but got HTML. Check server logs.');
                    return;
                }

                const data = await response.json();
                console.log('Delete response:', data);

                if (response.ok) {
                    alert(`‚úÖ Order #${orderId} deleted successfully!`);
                    loadOrders();
                    loadStats();
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('‚ùå Error deleting order: ' + error.message);
            }
        }

        async function editProduct(id) {
            const product = currentProducts.find(p => p.id === id);
            if (!product) return;
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editName').value = product.name;
            document.getElementById('editPrice').value = product.price;
            document.getElementById('editCategory').value = product.category_id || '';
            document.getElementById('editIcon').value = product.icon;
            document.getElementById('editStock').value = product.stock || 100;
            document.getElementById('editDescription').value = product.description || '';
            document.getElementById('editImage').value = '';
            
            // Load and display existing images
            const preview = document.getElementById('imagePreview');
            try {
                const response = await fetch(API + '/products/' + id + '/images');
                const data = await response.json();
                
                if (data.images && data.images.length > 0) {
                    preview.innerHTML = '<p style="color: #666; margin-bottom: 10px;">Current Images (' + data.images.length + '):</p>';
                    data.images.forEach(img => {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.cssText = 'position: relative;';
                        imgDiv.innerHTML = '<img src="' + img.image_url + '" style="max-width: 150px; max-height: 150px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
                        preview.appendChild(imgDiv);
                    });
                } else if (product.image) {
                    preview.innerHTML = '<p style="color: #666; margin-bottom: 10px;">Current Image:</p><img src="' + product.image + '" style="max-width: 200px; border-radius: 5px;">';
                } else {
                    preview.innerHTML = '<p style="color: #999;">No images yet</p>';
                }
            } catch (error) {
                console.error('Error loading images:', error);
                if (product.image) {
                    preview.innerHTML = '<img src="' + product.image + '" style="max-width: 200px; border-radius: 5px;">';
                } else {
                    preview.innerHTML = '';
                }
            }
            
            document.getElementById('editModal').classList.add('active');
        }

        document.getElementById('editImage').addEventListener('change', function(e) {
            const files = e.target.files;
            const preview = document.getElementById('imagePreview');
            
            if (files.length > 0) {
                preview.innerHTML = '<p style="color: #666; margin-bottom: 10px;">New Images to Add:</p>';
                
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imgDiv = document.createElement('div');
                        imgDiv.style.cssText = 'position: relative;';
                        imgDiv.innerHTML = '<img src="' + e.target.result + '" style="max-width: 150px; max-height: 150px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
                        preview.appendChild(imgDiv);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        async function deleteProduct(id, name) {
            if (confirm('Are you sure you want to delete "' + name + '"? This cannot be undone!')) {
                try {
                    const response = await fetch(API + '/admin/products/' + id, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        alert('‚úÖ Product deleted successfully from database!');
                        loadProducts();
                        loadStats();
                    } else {
                        alert('‚ùå Error: ' + data.error);
                    }
                } catch (error) {
                    alert('‚ùå Error deleting product: ' + error.message);
                }
            }
        }

        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editProductId').value;
            
            try {
                // Upload images if new ones are selected (supports multiple)
                const imageFiles = document.getElementById('editImage').files;
                if (imageFiles.length > 0) {
                    console.log('Uploading', imageFiles.length, 'new image(s) for product:', id);
                    const formData = new FormData();
                    
                    // Add all images to FormData
                    Array.from(imageFiles).forEach(file => {
                        formData.append('images', file);
                    });
                    
                    const uploadResponse = await fetch(API + '/admin/products/' + id + '/upload-multiple', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const uploadData = await uploadResponse.json();
                    console.log('Images upload response:', uploadData);
                    if (!uploadResponse.ok) {
                        alert('‚ö†Ô∏è Images upload failed: ' + uploadData.error);
                        return;
                    }
                    console.log('Images uploaded successfully');
                }
                
                // Update product data (without image field - image is handled separately)
                const productData = {
                    name: document.getElementById('editName').value,
                    price: parseFloat(document.getElementById('editPrice').value),
                    category_id: parseInt(document.getElementById('editCategory').value) || null,
                    icon: document.getElementById('editIcon').value,
                    stock: parseInt(document.getElementById('editStock').value),
                    description: document.getElementById('editDescription').value
                };
                
                console.log('Updating product data:', productData);
                const response = await fetch(API + '/admin/products/' + id, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Product updated successfully!');
                    closeModal();
                    // Small delay to ensure database is updated
                    setTimeout(() => {
                        loadProducts();
                        loadStats();
                    }, 300);
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error updating product:', error);
                alert('‚ùå Error updating product: ' + error.message);
            }
        });

        function showSection(section) {
            document.getElementById(section + '-section').scrollIntoView({ behavior: 'smooth' });
        }

        async function loadContacts() {
            try {
                const response = await fetch(API + '/admin/contacts');
                const data = await response.json();
                console.log('Contacts loaded:', data.contacts);
                const tbody = document.getElementById('contactsTable');
                if (data.contacts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7">No contact messages yet</td></tr>';
                } else {
                    tbody.innerHTML = data.contacts.map(contact => {
                        const statusBadge = contact.status === 'new' 
                            ? '<span class="badge" style="background: #dbeafe; color: #1e40af;">üÜï New</span>'
                            : '<span class="badge" style="background: #e5e7eb; color: #6b7280;">‚úì Read</span>';
                        
                        return `
                            <tr>
                                <td>${contact.id}</td>
                                <td>${contact.name}</td>
                                <td>${contact.email}</td>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${contact.message}</td>
                                <td>${statusBadge}</td>
                                <td>${new Date(contact.created_at).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-edit" onclick="updateContactStatus(${contact.id}, 'read')" style="background: #10b981; margin-right: 5px;">
                                        <i class="fas fa-check"></i> Mark Read
                                    </button>
                                    <button class="btn btn-delete" onclick="deleteContact(${contact.id})">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        async function updateContactStatus(contactId, status) {
            try {
                const response = await fetch(API + '/admin/contacts/' + contactId + '/status', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });

                if (response.ok) {
                    alert('‚úÖ Contact status updated!');
                    loadContacts();
                } else {
                    alert('‚ùå Failed to update contact status');
                }
            } catch (error) {
                console.error('Error updating contact:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function deleteContact(contactId) {
            if (!confirm('Are you sure you want to delete this contact message?')) {
                return;
            }

            try {
                const response = await fetch(API + '/admin/contacts/' + contactId, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('‚úÖ Contact deleted!');
                    loadContacts();
                } else {
                    alert('‚ùå Failed to delete contact');
                }
            } catch (error) {
                console.error('Error deleting contact:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch(API + '/settings');
                const data = await response.json();
                
                // Populate form fields
                Object.keys(data.settings).forEach(key => {
                    const input = document.getElementById('setting_' + key);
                    if (input && input.type !== 'file') {
                        input.value = data.settings[key];
                    }
                    
                    // Also populate color text inputs
                    const textInput = document.getElementById('setting_' + key + '_text');
                    if (textInput) {
                        textInput.value = data.settings[key];
                    }
                });
                
                // Show current hero image if exists
                if (data.settings.hero_background_image) {
                    document.getElementById('heroImagePreview').innerHTML = 
                        '<p style="color: #666; margin-bottom: 5px;">Current Image:</p>' +
                        '<img src="' + data.settings.hero_background_image + '" style="max-width: 300px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        // Preview hero image before upload
        document.getElementById('setting_hero_image').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('heroImagePreview').innerHTML = 
                        '<p style="color: #666; margin-bottom: 5px;">Preview:</p>' +
                        '<img src="' + e.target.result + '" style="max-width: 300px; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">';
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Sync color pickers with text inputs
        function setupColorSync(colorId, textId) {
            const colorInput = document.getElementById(colorId);
            const textInput = document.getElementById(textId);
            
            colorInput.addEventListener('input', function() {
                textInput.value = this.value;
            });
            
            textInput.addEventListener('input', function() {
                if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                    colorInput.value = this.value;
                }
            });
        }
        
        setupColorSync('setting_primary_color', 'setting_primary_color_text');
        setupColorSync('setting_text_color', 'setting_text_color_text');
        setupColorSync('setting_heading_color', 'setting_heading_color_text');

        document.getElementById('settingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Settings form submitted');
            
            const msg = document.getElementById('settingsMessage');
            msg.textContent = '‚è≥ Saving settings...';
            msg.style.background = '#fef3c7';
            msg.style.color = '#92400e';
            msg.style.display = 'block';
            
            try {
                // Upload hero image if selected
                const imageFile = document.getElementById('setting_hero_image').files[0];
                if (imageFile) {
                    console.log('Uploading image...');
                    const formData = new FormData();
                    formData.append('image', imageFile);
                    
                    const uploadResponse = await fetch(API + '/admin/settings/hero-image/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error('Image upload failed');
                    }
                    console.log('Image uploaded successfully');
                }
                
                // Save text settings
                const settings = {
                    site_name: document.getElementById('setting_site_name').value,
                    hero_title: document.getElementById('setting_hero_title').value,
                    hero_subtitle: document.getElementById('setting_hero_subtitle').value,
                    hero_button_text: document.getElementById('setting_hero_button_text').value,
                    about_text: document.getElementById('setting_about_text').value,
                    primary_color: document.getElementById('setting_primary_color').value,
                    text_color: document.getElementById('setting_text_color').value,
                    heading_color: document.getElementById('setting_heading_color').value,
                    social_facebook: document.getElementById('setting_social_facebook').value,
                    social_instagram: document.getElementById('setting_social_instagram').value,
                    social_tiktok: document.getElementById('setting_social_tiktok').value,
                    social_telegram: document.getElementById('setting_social_telegram').value,
                    phone_number: document.getElementById('setting_phone_number').value,
                    telebirr_name: document.getElementById('setting_telebirr_name').value,
                    telebirr_phone: document.getElementById('setting_telebirr_phone').value,
                    telebirr_instructions: document.getElementById('setting_telebirr_instructions').value,
                    cbe_name: document.getElementById('setting_cbe_name').value,
                    cbe_account: document.getElementById('setting_cbe_account').value,
                    cbe_instructions: document.getElementById('setting_cbe_instructions').value,
                    bank_name: document.getElementById('setting_bank_name').value,
                    bank_account_name: document.getElementById('setting_bank_account_name').value,
                    bank_account_number: document.getElementById('setting_bank_account_number').value,
                    bank_instructions: document.getElementById('setting_bank_instructions').value,
                    font_family: document.getElementById('setting_font_family').value,
                    heading_font: document.getElementById('setting_heading_font').value
                };
                
                console.log('Saving settings:', settings);
                
                const promises = Object.keys(settings).map(key => 
                    fetch(API + '/admin/settings/' + key, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value: settings[key] })
                    })
                );
                
                const responses = await Promise.all(promises);
                console.log('All settings saved:', responses.length);
                
                msg.textContent = '‚úÖ Settings saved successfully! Refresh the main page to see changes.';
                msg.style.background = '#d1fae5';
                msg.style.color = '#065f46';
                msg.style.display = 'block';
                
                // Reload settings to show new image
                loadSettings();
                
                setTimeout(() => {
                    msg.style.display = 'none';
                }, 5000);
            } catch (error) {
                console.error('Error saving settings:', error);
                msg.textContent = '‚ùå Error saving settings: ' + error.message;
                msg.style.background = '#fee2e2';
                msg.style.color = '#991b1b';
                msg.style.display = 'block';
            }
        });

        window.addEventListener('DOMContentLoaded', () => {
            console.log('Loading admin dashboard...');
            loadCategories();
            loadStats();
            loadUsers();
            loadProducts();
            loadOrders();
            loadContacts();
            loadSettings();
        });
    </script>
</body>
</html>
